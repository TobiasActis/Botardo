name: Backtest Grid Search

on:
  workflow_dispatch:
    inputs:
      start_date:
        description: 'Start date for backtest (YYYY-MM-DD)'
        required: true
        default: '2024-01-01'
      end_date:
        description: 'End date for backtest (YYYY-MM-DD)'
        required: false
      leverage_range:
        description: 'Leverage range (e.g., 1,3,5)'
        required: true
        default: '1,3,5'

jobs:
  backtest:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        leverage: ${{ fromJson(format('[{0}]', github.event.inputs.leverage_range)) }}
        risk_per_trade: [0.01, 0.02, 0.03]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Download historical data
      run: |
        python download_btc_futures_1m.py
    
    - name: Run backtest
      env:
        BINANCE_API_KEY: ${{ secrets.BINANCE_TESTNET_API_KEY }}
        BINANCE_API_SECRET: ${{ secrets.BINANCE_TESTNET_API_SECRET }}
        BINANCE_TESTNET: true
        MAX_LEVERAGE: ${{ matrix.leverage }}
        RISK_PER_TRADE: ${{ matrix.risk_per_trade }}
        BACKTEST_START_DATE: ${{ github.event.inputs.start_date }}
        BACKTEST_END_DATE: ${{ github.event.inputs.end_date }}
      run: |
        python backtest_wyckoff.py > backtest_results.txt
    
    - name: Upload results
      uses: actions/upload-artifact@v3
      with:
        name: backtest-lev${{ matrix.leverage }}-risk${{ matrix.risk_per_trade }}
        path: |
          backtest_results.txt
          backtest_results.png
          data/*.csv
    
    - name: Extract metrics
      id: metrics
      run: |
        # Extraer mÃ©tricas clave del output
        TOTAL_RETURN=$(grep "Total P&L:" backtest_results.txt | awk '{print $4}' | tr -d '()%')
        WIN_RATE=$(grep "Win Rate:" backtest_results.txt | awk '{print $3}' | tr -d '%')
        MAX_DD=$(grep "Max Drawdown:" backtest_results.txt | awk '{print $3}' | tr -d '%')
        SHARPE=$(grep "Sharpe Ratio:" backtest_results.txt | awk '{print $3}')
        
        echo "return=$TOTAL_RETURN" >> $GITHUB_OUTPUT
        echo "winrate=$WIN_RATE" >> $GITHUB_OUTPUT
        echo "drawdown=$MAX_DD" >> $GITHUB_OUTPUT
        echo "sharpe=$SHARPE" >> $GITHUB_OUTPUT
    
    - name: Comment results on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const output = `
          ### Backtest Results ðŸ“Š
          
          **Configuration:**
          - Leverage: ${{ matrix.leverage }}x
          - Risk per Trade: ${{ matrix.risk_per_trade }}
          - Period: ${{ github.event.inputs.start_date }} to ${{ github.event.inputs.end_date || 'now' }}
          
          **Metrics:**
          - Total Return: ${{ steps.metrics.outputs.return }}%
          - Win Rate: ${{ steps.metrics.outputs.winrate }}%
          - Max Drawdown: ${{ steps.metrics.outputs.drawdown }}%
          - Sharpe Ratio: ${{ steps.metrics.outputs.sharpe }}
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          });

  summarize:
    needs: backtest
    runs-on: ubuntu-latest
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v3
    
    - name: Generate summary report
      run: |
        echo "# Backtest Grid Search Summary" > summary.md
        echo "" >> summary.md
        echo "| Leverage | Risk % | Return % | Win Rate % | Max DD % | Sharpe |" >> summary.md
        echo "|----------|--------|----------|------------|----------|--------|" >> summary.md
        
        for dir in backtest-lev*; do
          if [ -f "$dir/backtest_results.txt" ]; then
            LEV=$(echo $dir | grep -oP 'lev\K[0-9]+')
            RISK=$(echo $dir | grep -oP 'risk\K[0-9.]+')
            RET=$(grep "Total P&L:" "$dir/backtest_results.txt" | awk '{print $4}' | tr -d '()%')
            WR=$(grep "Win Rate:" "$dir/backtest_results.txt" | awk '{print $3}' | tr -d '%')
            DD=$(grep "Max Drawdown:" "$dir/backtest_results.txt" | awk '{print $3}' | tr -d '%')
            SR=$(grep "Sharpe Ratio:" "$dir/backtest_results.txt" | awk '{print $3}')
            
            echo "| ${LEV}x | $RISK | $RET | $WR | $DD | $SR |" >> summary.md
          fi
        done
        
        cat summary.md
    
    - name: Upload summary
      uses: actions/upload-artifact@v3
      with:
        name: grid-search-summary
        path: summary.md
    
    - name: Post summary to PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('summary.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });
